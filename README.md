# digital_leaders_backend
1# case by Gazprombank
 
![Out_Logo_Team](https://i.ibb.co/pyQp8Ww/image.png)


Требования:
* `python 3.7.6 или новее`

чтобы произвести сборку проекта, нужно:

* `git clone`
* `pip install -r requirements.txt`
* `cd /backend && git submodule add https://github.com/MrShepardd/gis_mercury && git submodule init && git submodule update`
* `в корне проекта создать файл db.sqlite3`
* `python manage.py makemigrations`
* `python manage.py migrate`
* `создать папку data в корне проекта и добавить туда файлы: atm-list.txt, atm-list-yandex.txt, gas_station.txt, shopping-mall.txt, stops-yandex.txt Они подготавливались заранее.`
* `в папке data создать папку precalculation`
* `вызвать по-очереди методы из файла api/cron.py, такие как: download_all_stops, download_all_district, download_all_atm, refill_db. Достигается это следующими командами:`
    * `python3 manage.py shell`
    * `from api.cron import download_all_stops`
    * `download_all_stops` (ждем; остальные скрипты аналогично) 
* `должны быть запущены cron задачи: (чтобы данные обновлялись раз в 2 недели; параметры запуска крона описаны в файле backend/settings.py)`
    * `проверка есть ли задачи: python3 manage.py crontab show`
    * `если задач нет - python3 manage.py crontab add`

на выходе должна получиться готовая БД `db.sqlite3` и собранный проект

# структура проекта

* `api/`
    * `models.py` - структура базы данных в синтаксисе django
    * `cron.py` - функции, которые должны выполняться кроном раз в 2 недели + доп функции. Все данные, полученные этими функциями сохраняются в папку `data/`, либо обновляют `db.sqlite3`
    * `urls.py` - файл для роутов
    * `auth.py` - файл, который в перспективе должен проверять авторизацию пользователя и отдавать результат проверки.
    * `utilities.py` - содержит некоторые вспомогательные функции.
    * `api/db_utilities/`
        * в данной папке расположены скрипты, которые берут данные из папки `data/` и заполняют базу данных. Данные скрипты используются в файле `cron.py`. Создается экземпляр объекта `DBFiller`, к которому присоединяются экземпляры классов, каждый из которых отвечают за свою таблицу (см. файл `cron.py`) и вызывается метод, заполняющий всю БД. 
    * `api/mercury/`
        * В данной директории происходит получение данных из базы данных, а также производятся не сложные рассчеты и отправляются на дашборд. Главным здесь является файл `mercury.py`, класс, методы которого возвращают данные для отдельных страниц дашборда.
        * Для каждой отдельной страницы дашборда в этой папке создается файл, который реализует функционал сбора из БД необходимых данных и формирования метрик.
        * Поскольку некоторые метрики требуют алгоритмические рассчеты над большим количеством данных и их нельзя достать за короткое время, в ряде файлов реализована функция `make_precalculation`, которая делает рассчеты и сохраняет предрассчитанные данные в директорию `data/pre_calculation/`. Данная функция содержится внутри функции `api/cron.py refill_db`, вызов происходит следующим способом: `GeneralReview().make_precalculation()`.
* `backend/`
    * файлы в данном разделе являются стандартными для любых django проектов, изменялся только файл `settings.py`, в котором содержится вся техническая конфигурация проекта.
    * `backend/gis_mercury` - сабмодуль с функционалом скачивания необходимых для работы бэкенда данных. Содержится в отдельном репозитории
    